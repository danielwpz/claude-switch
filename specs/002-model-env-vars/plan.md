# Implementation Plan: Per-Provider Model Environment Variables

**Branch**: `002-model-env-vars` | **Date**: 2025-11-14 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-model-env-vars/spec.md`

## Summary

This feature adds two optional environment variables (ANTHROPIC_MODEL and ANTHROPIC_SMALL_FAST_MODEL) to the provider configuration system. Users can configure these values when setting up or editing a provider via interactive CLI prompts. These variables will be exported to the shell session alongside existing ANTHROPIC_BASE_URL and ANTHROPIC_AUTH_TOKEN when switching providers.

**Technical Approach**: Extend the existing ProviderConfig schema to include optional model fields; update provider setup/edit prompts to collect model values; integrate model export into the existing shell export mechanism.

## Technical Context

**Language/Version**: Node.js 18+ with TypeScript 5.x
**Primary Dependencies**: Existing config system, shell export mechanism (no new external dependencies required)
**Storage**: JSON config file at `~/.cswitch/config.json` (existing mechanism)
**Testing**: Vitest (existing test framework)
**Target Platform**: CLI (Node.js on macOS/Linux/Windows)
**Project Type**: Single CLI project with TypeScript
**Performance Goals**: Negligible impact; configuration lookup is O(1), environment variable export is synchronous
**Constraints**: Must maintain backward compatibility with existing config files; config file encryption/permissions unchanged
**Scale/Scope**: Adds 2 optional string fields per provider; affects provider config schema, setup flow, and export logic

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| **I. Code Quality Excellence** | ✅ PASS | Type-safe schema extension (TypeScript); will follow DRY and single-responsibility for new functions; linting/formatting enforced |
| **II. Testing Standards (NON-NEGOTIABLE)** | ✅ PASS | Feature requires contract tests (config schema), integration tests (setup/edit flow), and unit tests (validation); test-first approach applied |
| **III. User Experience Consistency** | ✅ PASS | Interactive prompts match existing provider setup pattern; error messages and blank-skipping align with current behavior |
| **IV. Performance Requirements** | ✅ PASS | No performance constraints violated; config lookup remains O(1); no blocking I/O added |
| **V. Security & Reliability** | ✅ PASS | Model values treated as user-provided strings (validated/sanitized); no new dependencies; config file permissions unchanged (600); backward compatible |

**Gate Result**: PASS - No violations detected. Proceed to Phase 0.

## Project Structure

### Documentation (this feature)

```text
specs/002-model-env-vars/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Phase 0 research (TBD)
├── data-model.md        # Phase 1 data model (TBD)
├── quickstart.md        # Phase 1 quickstart (TBD)
├── contracts/           # Phase 1 contracts (TBD)
├── checklists/
│   └── requirements.md  # Quality checklist
└── tasks.md             # Phase 2 tasks (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
src/
├── config/
│   ├── schema.ts                    # Schema extension: add anthropicModel, anthropicSmallFastModel to Provider
│   └── config.ts                    # Validation logic for model fields (empty string handling)
├── actions/
│   ├── setup.ts                     # Update: add model prompts to provider setup flow
│   ├── edit.ts                      # New/Update: edit provider with model prompts (reuse setup logic)
│   └── switch.ts                    # No changes (switch already exports all provider fields)
├── prompts/
│   └── provider.ts                  # Update: add ANTHROPIC_MODEL and ANTHROPIC_SMALL_FAST_MODEL prompts
├── shell/
│   └── export.ts                    # Update: include model vars in export command generation
└── lib/
    └── validation.ts                # Update: add validator for model field (trim whitespace, accept empty)

tests/
├── contract/
│   └── schema-extension.test.ts     # Contract: Provider schema with model fields
├── integration/
│   ├── setup-with-models.test.ts    # Integration: setup provider with models
│   ├── edit-with-models.test.ts     # Integration: edit provider models
│   └── switch-with-models.test.ts   # Integration: switch exports model vars
└── unit/
    ├── model-validation.test.ts     # Unit: validate empty string, whitespace, valid model names
    └── export-with-models.test.ts   # Unit: export command generation with/without models
```

**Structure Decision**: Single TypeScript CLI project. Leverages existing file-based config system and modular action structure. No new dependencies or architectural changes required.

## Complexity Tracking

No Constitution Check violations. All changes are additive and maintain backward compatibility.

---

## Phase 0: Research & Unknowns

**Status**: ✅ COMPLETE

**Known Context**:
- Existing provider schema in `src/config/schema.ts` defines Provider interface with baseUrl, displayName, tokens[]
- Existing prompts in `src/prompts/provider.ts` handle provider setup (name, URL, token)
- Existing export in `src/shell/export.ts` generates shell commands for ANTHROPIC_BASE_URL and ANTHROPIC_AUTH_TOKEN
- Auto-load mechanism in `src/shell/init.ts` evaluates export commands in new shell sessions
- Config file at `~/.cswitch/config.json` with 0o600 permissions (atomic writes enforced)

**Research Tasks**:
1. Confirm backward compatibility strategy: old config files without model fields should load successfully
2. Validate empty string handling: whitespace-only strings should be treated as not configured
3. Review edit provider flow: determine if edit command exists or needs creation

**Deliverable**: `research.md` with findings and decisions for each task

---

## Phase 1: Design & Contracts

**Status**: ✅ COMPLETE

**Deliverables**:

### 1. Data Model ✅ (`data-model.md`)
- Extended ProviderConfig interface with optional anthropicModel and anthropicSmallFastModel fields
- Defined validation rules (empty/whitespace handling via normalizeModelField)
- Documented state transitions (configure → switch → unset → reconfigure)
- Specified storage format and backward compatibility

### 2. API Contracts ✅ (`contracts/`)
- **provider-schema.contract.md**: Provider config schema contract with model fields, serialization rules, backward compat
- **shell-export.contract.md**: Export command generation contract (7 test scenarios with expected outputs)

### 3. Quickstart ✅ (`quickstart.md`)
- Scenario 1: Set up provider with both models
- Scenario 2: Configure only one model
- Scenario 3: Edit provider to add/change models
- Scenario 4: Clear/unset models
- Scenario 5: Use models in Python, JavaScript, and shell scripts
- Scenario 6: Multiple providers with different models
- Scenario 7: Auto-load in new shell sessions
- Common use cases and troubleshooting

### 4. Agent Context Update
- Pending: Run after Phase 1 review

---

## Next Steps

1. ✅ Phase 0: Research complete (research.md)
2. ✅ Phase 1: Design & contracts complete (data-model.md, contracts/, quickstart.md)
3. **Recommended next**: Run `/speckit.plan` to review; then `/speckit.tasks` to generate implementation task breakdown
4. **Then**: Begin implementation with test-first approach

### Artifacts Summary

| Artifact | Status | Purpose |
|----------|--------|---------|
| `plan.md` | ✅ Complete | Overview and technical context |
| `research.md` | ✅ Complete | Unknowns resolved; implementation decisions |
| `data-model.md` | ✅ Complete | Entity definitions, state transitions, storage |
| `contracts/provider-schema.contract.md` | ✅ Complete | Schema extension contract with tests |
| `contracts/shell-export.contract.md` | ✅ Complete | Export generation contract with 7 scenarios |
| `quickstart.md` | ✅ Complete | 7 user scenarios + troubleshooting |
| `spec.md` | ✅ Complete | Feature specification (linked) |
| `tasks.md` | ⏳ Pending | Generated by `/speckit.tasks` command |
